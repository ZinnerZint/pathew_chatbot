import streamlit as st
from chatbot import get_answer

# ---------- Page setup ----------
st.set_page_config(page_title="Pathew Chatbot", page_icon="üå¥", layout="centered")
st.markdown(
    "<h1 style='margin-bottom:0'> AI Chatbot ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß</h1>",
    unsafe_allow_html=True,
)
st.caption("‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô: *‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡∏ô*, *‡∏°‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡πÑ‡∏´‡∏°*")

# ---------- Avatar Icons ----------
USER_AVATAR = "https://img.icons8.com/?size=100&id=111699&format=png&color=FF0000"  # ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ô ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏î‡∏á
BOT_AVATAR = "https://img.icons8.com/?size=100&id=111693&format=png&color=FFAA00"   # ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ö‡∏≠‡∏ó ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡πâ‡∏°

# ---------- Session state ----------
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏ô‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ "}
    ]

# ---------- Render history ----------
for msg in st.session_state.messages:
    avatar = USER_AVATAR if msg["role"] == "user" else BOT_AVATAR
    with st.chat_message(msg["role"], avatar=avatar):
        st.markdown(msg["content"])

# ---------- Chat input ----------
user_input = st.chat_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‚Ä¶")

if user_input:
    # ‡πÅ‡∏™‡∏î‡∏á + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user", avatar=USER_AVATAR):
        st.markdown(user_input)

    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏°‡∏≠‡∏á
    reply_text, places = get_answer(user_input)

    # ‡πÅ‡∏™‡∏î‡∏á + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏ö‡∏≠‡∏ó
    with st.chat_message("assistant", avatar=BOT_AVATAR):
        st.markdown(reply_text)

        # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û/‡∏•‡∏¥‡∏á‡∏Å‡πå
        if places:
            for p in places:
                name = p.get("name", "-")
                desc = (p.get("description") or "").strip()
                img = p.get("image_url")
                lat, lng = p.get("latitude"), p.get("longitude")
                map_link = f"https://www.google.com/maps?q={lat},{lng}" if lat and lng else None

                with st.container(border=True):
                    cols = st.columns([1, 2])
                    with cols[0]:
                        if isinstance(img, str) and img.startswith("http"):
                            st.image(img, use_container_width=True)
                        else:
                            st.markdown("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ")
                    with cols[1]:
                        st.markdown(f"**{name}**  \n{desc or '‚Äî'}")
                        st.markdown(f"**‡∏ï‡∏≥‡∏ö‡∏•:** {p.get('tambon','-')}  |  **‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:** {p.get('category','-')}")
                        if map_link:
                            st.markdown(f"[‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà]({map_link})")

    st.session_state.messages.append({"role": "assistant", "content": reply_text})
